%% Utility macros
-define(normalize_float(Float, Vars),
        case maps:get(poc_version, Vars, undefined) of
            V when is_integer(V), V > 4 ->
                blockchain_utils:normalize_float(Float);
            _ ->
                Float
        end).

-define(TO_B58(X), libp2p_crypto:bin_to_b58(X)).
-define(TO_ANIMAL_NAME(X), element(2, erl_angry_purple_tiger:animal_name(libp2p_crypto:bin_to_b58(X)))).

-define(SNR_CURVE, #{12 => {-90,-35},
                     4 => {-115,-112},
                     -4 => {-125,-125},
                     16 => {-90,-35},
                     -15 => {-124,-124},
                     -6 => {-124,-124},
                     -1 => {-125,-125},
                     -2 => {-125,-125},
                     5 => {-115,-100},
                     14 => {-90,-35},
                     -11 => {-125,-125},
                     9 => {-95,-45},
                     10 => {-90,-40},
                     -12 => {-125,-125},
                     -7 => {-123,-123},
                     -10 => {-125,-125},
                     -14 => {-125,-125},
                     2 => {-117,-112},
                     6 => {-113,-100},
                     -5 => {-125,-125},
                     3 => {-115,-112},
                     -3 => {-125,-125},
                     1 => {-120,-117},
                     7 => {-108,-45},
                     8 => {-105,-45},
                     -8 => {-125,-125},
                     0 => {-125,-125},
                     13 => {-90,-35},
                     -16 => {-123,-123},
                     -17 => {-123,-123},
                     -18 => {-123,-123},
                     -19 => {-123,-123},
                     -20 => {-123,-123},
                     15 => {-90,-35},
                     -9 => {-125,-125},
                     -13 => {-125,-125},
                     11 => {-90,-35}}).


%% See https://gist.github.com/JayKickliter/dfc44797afca5e2811627d107322b6ad
%%                      RSSIS => SNR
-define(SNR_CURVE_915, #{ -10 => 13.5,
                          -11 => 13.5,
                          -12 => 13.4,
                          -13 => 13.4,
                          -14 => 13.4,
                          -15 => 13.4,
                          -16 => 13.3,
                          -17 => 13.4,
                          -18 => 13.4,
                          -19 => 13.4,
                          -20 => 13.4,
                          -21 => 13.4,
                          -22 => 13.5,
                          -23 => 13.5,
                          -24 => 13.5,
                          -25 => 13.5,
                          -26 => 13.6,
                          -27 => 13.6,
                          -28 => 13.6,
                          -29 => 13.6,
                          -30 => 13.6,
                          -31 => 13.6,
                          -32 => 13.6,
                          -33 => 13.6,
                          -34 => 13.6,
                          -35 => 13.6,
                          -36 => 13.6,
                          -37 => 13.6,
                          -38 => 13.5,
                          -39 => 13.5,
                          -40 => 13.5,
                          -41 => 13.4,
                          -42 => 13.4,
                          -43 => 13.4,
                          -44 => 13.3,
                          -45 => 13.3,
                          -46 => 13.2,
                          -47 => 13.2,
                          -48 => 13.1,
                          -49 => 13.1,
                          -50 => 13.1,
                          -51 => 13.0,
                          -52 => 13.0,
                          -53 => 12.9,
                          -54 => 12.9,
                          -55 => 12.9,
                          -56 => 12.8,
                          -57 => 12.8,
                          -58 => 12.8,
                          -59 => 12.8,
                          -60 => 12.8,
                          -61 => 12.7,
                          -62 => 12.7,
                          -63 => 12.7,
                          -64 => 12.7,
                          -65 => 12.8,
                          -66 => 12.8,
                          -67 => 12.8,
                          -68 => 12.8,
                          -69 => 12.8,
                          -70 => 12.9,
                          -71 => 12.9,
                          -72 => 13.0,
                          -73 => 13.0,
                          -74 => 13.0,
                          -75 => 13.1,
                          -76 => 13.1,
                          -77 => 13.2,
                          -78 => 13.2,
                          -79 => 13.2,
                          -80 => 13.3,
                          -81 => 13.3,
                          -82 => 13.3,
                          -83 => 13.3,
                          -84 => 13.3,
                          -85 => 13.3,
                          -86 => 13.3,
                          -87 => 13.2,
                          -88 => 13.2,
                          -89 => 13.1,
                          -90 => 13.0,
                          -91 => 12.9,
                          -92 => 12.8,
                          -93 => 12.6,
                          -94 => 12.4,
                          -95 => 12.2,
                          -96 => 12.0,
                          -97 => 11.7,
                          -98 => 11.4,
                          -99 => 11.1,
                          -100 => 10.7,
                          -101 => 10.3,
                          -102 => 9.9,
                          -103 => 9.4,
                          -104 => 8.9,
                          -105 => 8.3,
                          -106 => 7.8,
                          -107 => 7.1,
                          -108 => 6.5,
                          -109 => 5.8,
                          -110 => 5.0,
                          -111 => 4.2,
                          -112 => 3.4,
                          -113 => 2.6,
                          -114 => 1.7,
                          -115 => 0.8,
                          -116 => -0.1,
                          -117 => -1.1,
                          -118 => -2.1,
                          -119 => -3.1,
                          -120 => -4.1,
                          -121 => -5.1,
                          -122 => -6.2,
                          -123 => -7.2,
                          -124 => -8.2,
                          -125 => -9.2,
                          -126 => -10.1,
                          -127 => -11.1,
                          -128 => -11.9,
                          -129 => -12.8,
                          -130 => -13.5,
                          -131 => -14.2,
                          -132 => -14.0 % guess
                        }).

-define(SNR_CURVE_915_CLAMP(Val), min(max(Val, lists:max(maps:keys(?SNR_CURVE_915))), lists:min(maps:keys(?SNR_CURVE_915)))).


%% See https://gist.github.com/JayKickliter/dfc44797afca5e2811627d107322b6ad
%%                     RSSIS => SNR
-define(SNR_CURVE_868, #{ -7 => 7.6,
                          -8 => 7.8,
                          -9 => 7.8,
                          -10 => 7.9,
                          -11 => 8.0,
                          -12 => 8.0,
                          -13 => 8.0,
                          -14 => 8.0,
                          -15 => 8.0,
                          -16 => 8.0,
                          -17 => 8.0,
                          -18 => 7.9,
                          -19 => 7.9,
                          -20 => 7.9,
                          -21 => 7.8,
                          -22 => 7.8,
                          -23 => 7.8,
                          -24 => 7.7,
                          -25 => 7.7,
                          -26 => 7.7,
                          -27 => 7.6,
                          -28 => 7.6,
                          -29 => 7.6,
                          -30 => 7.5,
                          -31 => 7.5,
                          -32 => 7.5,
                          -33 => 7.5,
                          -34 => 7.5,
                          -35 => 7.4,
                          -36 => 7.4,
                          -37 => 7.4,
                          -38 => 7.4,
                          -39 => 7.4,
                          -40 => 7.4,
                          -41 => 7.4,
                          -42 => 7.4,
                          -43 => 7.4,
                          -44 => 7.4,
                          -45 => 7.4,
                          -46 => 7.4,
                          -47 => 7.4,
                          -48 => 7.4,
                          -49 => 7.4,
                          -50 => 7.4,
                          -51 => 7.4,
                          -52 => 7.4,
                          -53 => 7.4,
                          -54 => 7.4,
                          -55 => 7.4,
                          -56 => 7.4,
                          -57 => 7.4,
                          -58 => 7.4,
                          -59 => 7.4,
                          -60 => 7.4,
                          -61 => 7.4,
                          -62 => 7.4,
                          -63 => 7.4,
                          -64 => 7.4,
                          -65 => 7.4,
                          -66 => 7.4,
                          -67 => 7.4,
                          -68 => 7.4,
                          -69 => 7.4,
                          -70 => 7.4,
                          -71 => 7.4,
                          -72 => 7.4,
                          -73 => 7.4,
                          -74 => 7.4,
                          -75 => 7.4,
                          -76 => 7.3,
                          -77 => 7.3,
                          -78 => 7.3,
                          -79 => 7.3,
                          -80 => 7.3,
                          -81 => 7.3,
                          -82 => 7.3,
                          -83 => 7.3,
                          -84 => 7.3,
                          -85 => 7.2,
                          -86 => 7.2,
                          -87 => 7.2,
                          -88 => 7.1,
                          -89 => 7.1,
                          -90 => 7.0,
                          -91 => 6.9,
                          -92 => 6.9,
                          -93 => 6.8,
                          -94 => 6.7,
                          -95 => 6.5,
                          -96 => 6.4,
                          -97 => 6.3,
                          -98 => 6.1,
                          -99 => 5.9,
                          -100 => 5.7,
                          -101 => 5.5,
                          -102 => 5.3,
                          -103 => 5.0,
                          -104 => 4.8,
                          -105 => 4.5,
                          -106 => 4.1,
                          -107 => 3.8,
                          -108 => 3.4,
                          -109 => 3.0,
                          -110 => 2.5,
                          -111 => 2.1,
                          -112 => 1.6,
                          -113 => 1.0,
                          -114 => 0.5,
                          -115 => -0.1,
                          -116 => -0.7,
                          -117 => -1.4,
                          -118 => -2.1,
                          -119 => -2.8,
                          -120 => -3.6,
                          -121 => -4.4,
                          -122 => -5.2,
                          -123 => -6.1,
                          -124 => -7.0,
                          -125 => -7.9,
                          -126 => -8.8,
                          -127 => -9.8,
                          -128 => -10.8,
                          -129 => -11.8,
                          -130 => -12.8,
                          -131 => -13.9,
                          -132 => -14.9,
                          -133 => -16.0,
                          -134 => -17.0,
                          -135 => -18.1,
                          -136 => -19.1,
                          -137 => -20.1,
                          -138 => -21.1,
                          -139 => -22.0,
                          -140 => -22.9
                        }).
-define(SNR_CURVE_868_CLAMP(Val), min(max(Val, lists:max(maps:keys(?SNR_CURVE_868))), lists:min(maps:keys(?SNR_CURVE_868)))).

-define(MAX_UNIQ_CLIENTS, 1100).

%% default values for gateways
-define(DEFAULT_GAIN, 12). %% as dBi * 10
-define(DEFAULT_ELEVATION, 0). %% as AGL (above ground level) in meters
